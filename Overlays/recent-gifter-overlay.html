<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recent Gifter - Top Left</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;700;900&display=swap');

        :root {
            /* === Color Group 4: Mono/Metallic === */
            --fabric-dark: #050505;
            --fabric-mid: #151515;
            --fabric-bright: #252525;
            --fabric-mid2: #1a1a1a;
            --fabric-deep: #0a0a0a;

            /* === Color Group 2: Accent === */
            --neon-green: #ffffff;
            /* White toggle */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 1s ease, color 1s ease, border-color 1s ease, box-shadow 1s ease;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .gifter-anchor {
            position: fixed;
            top: 0;
            left: 50%;
            width: 640px;
            height: 110px;
            border-radius: 0 0 50px 50px;
            overflow: visible;
            filter:
                drop-shadow(0 3px 0 rgba(255, 255, 255, 0.05)) drop-shadow(0 14px 24px rgba(0, 0, 0, 0.5)) drop-shadow(0 24px 42px rgba(0, 0, 0, 0.36)) drop-shadow(0 0 28px rgba(0, 0, 0, 0.2));
            transform: translateX(-50%) translateY(0);
            transform-origin: top center;
            opacity: 1;
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.5s ease;
            perspective: 1200px;
            will-change: transform;
        }

        .main-surface {
            position: absolute;
            inset: 0;
            border-radius: 0 0 50px 50px;
            background: linear-gradient(145deg,
                    var(--fabric-dark) 0%,
                    var(--fabric-mid) 24%,
                    var(--fabric-mid2) 52%,
                    var(--fabric-deep) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-top: none;
            box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            align-items: center;
            transform: none;
            transform-style: flat;
            will-change: auto;
        }

        .main-surface::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 3;
            pointer-events: none;
            opacity: 0.5;
            mix-blend-mode: overlay;
            background:
                repeating-linear-gradient(112deg,
                    rgba(255, 255, 255, 0.08) 0 2px,
                    transparent 2px 11px),
                linear-gradient(90deg,
                    rgba(255, 255, 255, 0.06) 0%,
                    transparent 22%,
                    rgba(255, 255, 255, 0.03) 42%,
                    transparent 58%,
                    rgba(255, 255, 255, 0.07) 78%,
                    transparent 100%);
            transform: translateX(-7%);
            animation: fabric-drift 14s linear infinite alternate;
        }

        .main-surface::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 4;
            pointer-events: none;
            opacity: 0.42;
            mix-blend-mode: screen;
            background:
                linear-gradient(120deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.05) 26%,
                    transparent 34%,
                    rgba(255, 255, 255, 0.035) 47%,
                    transparent 58%,
                    rgba(255, 255, 255, 0.05) 70%,
                    transparent 100%),
                repeating-linear-gradient(22deg,
                    rgba(0, 0, 0, 0.22) 0 4px,
                    transparent 4px 14px);
            animation: fabric-ripple 10s ease-in-out infinite;
        }

        .gifter-anchor.slide-in {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .gifter-anchor.slide-out {
            transform: translateX(-50%) translateY(-150%);
            opacity: 0;
            transition: transform 0.6s cubic-bezier(0.55, 0, 1, 0.45), opacity 0.4s ease;
        }

        /* Curved rim light: focused and brighter on the edges */
        .gifter-anchor::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0 0 50px 50px;
            pointer-events: none;
            z-index: 20;
            /* Curved bottom highlight */
            border-bottom: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(255, 255, 255, 0.15);
            /* Mask to keep only the corner segments bright */
            -webkit-mask-image: linear-gradient(90deg,
                    black 0%,
                    rgba(0, 0, 0, 0.5) 15%,
                    rgba(0, 0, 0, 0.15) 50%,
                    rgba(0, 0, 0, 0.5) 85%,
                    black 100%);
            mask-image: linear-gradient(90deg,
                    black 0%,
                    rgba(0, 0, 0, 0.5) 15%,
                    rgba(0, 0, 0, 0.15) 50%,
                    rgba(0, 0, 0, 0.5) 85%,
                    black 100%);
        }

        .poly-sheen {
            position: absolute;
            inset: 0;
            z-index: 7;
            pointer-events: none;
            mix-blend-mode: screen;
            opacity: var(--poly-alpha, 0.42);
            background:
                linear-gradient(118deg,
                    transparent 6%,
                    rgba(255, 255, 255, calc(0.04 + var(--crest, 0) * 0.06)) 28%,
                    rgba(255, 255, 255, calc(0.1 + var(--crest, 0) * 0.05)) var(--sheen-pos),
                    rgba(255, 255, 255, calc(0.04 + var(--crest, 0) * 0.06)) calc(var(--sheen-pos) + 16%),
                    transparent 88%);
            animation: sheen-sweep 8s linear infinite;
        }

        .rim-light {
            position: absolute;
            inset: 0;
            z-index: 8;
            pointer-events: none;
            border-radius: 0 0 50px 50px;
            background:
                linear-gradient(to right,
                    rgba(255, 255, 255, 0.15) 0%,
                    transparent 10%,
                    transparent 90%,
                    rgba(255, 255, 255, 0.1) 100%),
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.05) 48%,
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(255, 255, 255, 0.05) 52%,
                    transparent 100%),
                linear-gradient(to top,
                    rgba(255, 255, 255, 0.24) 0%,
                    rgba(255, 255, 255, 0.08) 18%,
                    transparent 36%);
            mix-blend-mode: overlay;
            opacity: var(--rim-alpha, 0.4);
            animation: rim-breathe 4.6s ease-in-out infinite;
        }

        .micro-noise {
            position: absolute;
            inset: 0;
            z-index: 9;
            pointer-events: none;
            opacity: 0.04;
            mix-blend-mode: overlay;
            background:
                repeating-linear-gradient(22deg, #fff 0px, #fff 1px, transparent 1px, transparent 3px),
                repeating-linear-gradient(112deg, #000 0px, #000 1px, transparent 1px, transparent 4px);
        }

        /* Removed Rim Highlight Pseudo */

        /* Hidden layers */
        .glass-overlay,
        .lightning-wash {
            display: none !important;
        }

        .content-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            padding: 0 18px 0 25px;
            pointer-events: none;
            animation: content-parallax 6.2s ease-in-out infinite;
            transform-origin: center center;
        }

        /* Lightning Wash Removed */

        .kick-icon {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            filter: drop-shadow(0 0 16px rgba(255, 255, 255, 0.5));
            transform: rotateZ(-5deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transform-style: preserve-3d;
            perspective: 1200px;
            isolation: isolate;
        }

        .kick-icon::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            background: radial-gradient(circle,
                    rgba(255, 255, 255, 0.46) 0%,
                    rgba(255, 255, 255, 0.14) 38%,
                    rgba(255, 255, 255, 0.04) 62%,
                    transparent 80%);
            filter: blur(3px);
            opacity: 0.95;
            animation: icon-glow-breathe 2.8s ease-in-out infinite;
        }

        .gift-icon-shell {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-style: preserve-3d;
            transform-origin: 50% 50%;
            transform-box: fill-box;
            animation: gift-spin-3d 4.8s linear infinite;
            will-change: transform;
            z-index: 1;
        }

        /* === 3D Extruded Gift Icon === */
        .gift-face {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .gift-face img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .gift-front {
            transform: translateZ(4px);
            backface-visibility: hidden;
        }

        .gift-front img {
            filter:
                brightness(1.55) contrast(1.35) drop-shadow(0 0 12px rgba(255, 255, 255, 0.44));
        }

        .gift-back {
            transform: rotateY(180deg) translateZ(4px);
            backface-visibility: hidden;
        }

        .gift-back img {
            filter:
                brightness(1.55) contrast(1.35) drop-shadow(0 0 12px rgba(255, 255, 255, 0.44));
        }

        /* JS-generated depth layers */
        .gift-depth-slice {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .gift-depth-slice img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .gifter-text-group {
            display: flex;
            flex-direction: column;
            gap: 0px;
            min-width: 0;
            animation: text-stack-drift 4.8s ease-in-out infinite;
            will-change: transform;
        }

        .ash-layer {
            position: absolute;
            inset: 0;
            z-index: 6;
            pointer-events: none;
            opacity: 0.85;
            mix-blend-mode: screen;
        }

        .gifter-label {
            font-family: 'Anton', sans-serif;
            font-size: 24px;
            letter-spacing: 2px;
            color: #ffffff;
            -webkit-text-fill-color: #ffffff;
            /* Brighter Premium Metallic */
            background: linear-gradient(180deg,
                    #ffffff 0%,
                    #ffffff 30%,
                    #f8f8f8 45%,
                    #f0f0f0 50%,
                    #f8f8f8 55%,
                    #ffffff 70%,
                    #ffffff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
            text-transform: uppercase;
            margin-bottom: -4px;
            transition: all 0.5s ease;
            animation: label-flicker 5.2s ease-in-out infinite;
        }

        .gifter-name {
            font-family: 'Inter', sans-serif;
            font-size: 52px;
            font-weight: 900;
            line-height: 1;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: linear-gradient(108deg,
                    var(--neon-green) 0%,
                    var(--neon-green) 25%,
                    #ffffff 50%,
                    var(--neon-green) 75%,
                    var(--neon-green) 100%);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            -webkit-text-stroke: 0.8px rgba(255, 255, 255, 0.25);
            filter: drop-shadow(0 2px 0 rgba(0, 0, 0, 0.5));
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
            max-width: none;
            padding-right: 12px;
            transition: color 0.5s ease, filter 0.5s ease, -webkit-text-stroke 0.5s ease;
            will-change: transform, filter, background-position;
        }

        /* === Text Glow === */
        .text-glow {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 10px var(--neon-green)) !important;
        }

        .label-glow {
            text-shadow: 0 0 10px var(--neon-green) !important;
        }

        .gifter-flash {
            animation: gifter-pop 0.8s cubic-bezier(0.16, 1, 0.3, 1) both !important;
        }

        .main-surface.event-burst {
            animation: burst-pulse 0.9s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .main-surface.event-burst .content-layer {
            animation: content-burst 0.9s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .main-surface.event-burst .kick-icon {
            animation: icon-burst 0.9s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .main-surface.event-burst .gifter-name {
            animation: name-burst 0.9s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        @keyframes gifter-pop {
            0% {
                filter: brightness(5) drop-shadow(0 0 30px #fff);
                transform: scale(1);
            }

            100% {
                filter: brightness(1) drop-shadow(0 1px 0 rgba(255, 255, 255, 0.25));
                transform: scale(1);
            }
        }

        @keyframes fabric-drift {
            0% {
                transform: translateX(-7%);
            }

            100% {
                transform: translateX(7%);
            }
        }

        @keyframes fabric-ripple {
            0% {
                transform: translateY(-2px) scaleX(1.012);
            }

            50% {
                transform: translateY(2px) scaleX(0.988);
            }

            100% {
                transform: translateY(-2px) scaleX(1.012);
            }
        }

        @keyframes sheen-sweep {
            0% {
                background-position: -40% 0;
            }

            100% {
                background-position: 140% 0;
            }
        }

        @keyframes rim-breathe {
            0% {
                opacity: 0.28;
            }

            50% {
                opacity: 0.52;
            }

            100% {
                opacity: 0.28;
            }
        }

        @keyframes burst-pulse {
            0% {
                filter: brightness(1.14) contrast(1.08);
            }

            100% {
                filter: brightness(1) contrast(1);
            }
        }

        @keyframes content-parallax {
            0% {
                transform: translateX(-3px) translateY(-1px) rotate(-0.45deg);
            }

            50% {
                transform: translateX(3px) translateY(2px) rotate(0.45deg);
            }

            100% {
                transform: translateX(-3px) translateY(-1px) rotate(-0.45deg);
            }
        }

        @keyframes gift-spin-3d {
            from {
                transform: rotateY(0deg);
            }

            to {
                transform: rotateY(360deg);
            }
        }

        @keyframes icon-glow-breathe {
            0% {
                transform: scale(0.94);
                opacity: 0.72;
            }

            50% {
                transform: scale(1.08);
                opacity: 1;
            }

            100% {
                transform: scale(0.94);
                opacity: 0.72;
            }
        }

        @keyframes text-stack-drift {
            0% {
                transform: translateX(-2px);
            }

            50% {
                transform: translateX(2px);
            }

            100% {
                transform: translateX(-2px);
            }
        }

        @keyframes name-drift {
            0% {
                transform: translateY(0px) scale(1);
            }

            50% {
                transform: translateY(-2px) scale(1.02);
            }

            100% {
                transform: translateY(0px) scale(1);
            }
        }

        @keyframes label-flicker {
            0% {
                opacity: 0.88;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.88;
            }
        }

        @keyframes content-burst {
            0% {
                transform: scale(1.03) translateY(-2px);
            }

            100% {
                transform: scale(1) translateY(0);
            }
        }

        @keyframes icon-burst {
            0% {
                transform: rotateZ(8deg) scale(1.14);
            }

            100% {
                transform: rotateZ(-5deg) scale(1);
            }
        }

        @keyframes name-burst {
            0% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 18px rgba(255, 255, 255, 0.65));
            }

            100% {
                transform: scale(1);
                filter: drop-shadow(0 2px 0 rgba(0, 0, 0, 0.5));
            }
        }

        .gold-applied .gifter-name {
            background: linear-gradient(180deg,
                    #ffed8a 0%,
                    #fcd04d 25%,
                    #d4af37 50%,
                    #8a6d3b 75%,
                    #d4af37 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-stroke: 1px rgba(255, 230, 0, 0.4);
            filter:
                drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8)) drop-shadow(0 0 20px rgba(212, 175, 55, 0.8)) drop-shadow(0 0 30px rgba(255, 215, 0, 0.4));
        }

        .gold-applied.gifter-anchor {
            box-shadow: 4px 4px 25px rgba(212, 175, 55, 0.4);
        }

        @media (prefers-reduced-motion: reduce) {
            .wave-container {
                transform: none;
            }

            .inner-fill,
            .content-layer {
                filter: none;
            }

            .poly-sheen,
            .rim-light,
            .micro-noise,
            .lightning-wash {
                display: none;
            }
        }
    </style>
</head>

<body>

    <div class="gifter-anchor" id="gifter-anchor">
        <div class="main-surface" id="wave-container">
            <div class="poly-sheen"></div>
            <div class="rim-light"></div>
            <div class="micro-noise"></div>
            <canvas class="ash-layer" id="ash-canvas"></canvas>

            <div class="content-layer">
                <!-- Gift Icon (3D Extruded) -->
                <div class="kick-icon">
                    <div class="gift-icon-shell" id="gift-shell">
                        <!-- Front face -->
                        <div class="gift-face gift-front">
                            <img src="../Logo/gift-icon.svg" alt="Gift">
                        </div>
                        <!-- Back face -->
                        <div class="gift-face gift-back">
                            <img src="../Logo/gift-icon.svg" alt="">
                        </div>
                        <!-- Edge depth layers generated by JS -->
                    </div>
                </div>

                <div class="gifter-text-group">
                    <div class="gifter-label">LATEST GIFTER</div>
                    <div class="gifter-name" id="gifter-name"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D Gift Icon Builder -->
    <script>
        (function build3DGiftIcon() {
            const shell = document.getElementById('gift-shell');
            if (!shell) return;

            const HALF_DEPTH = 3.75;
            const LAYER_COUNT = 30;

            // Hollow SVG for transparent edges (thick white stroke, no fill)
            const hollowSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='3.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 12 20 22 4 22 4 12'/%3E%3Crect x='2' y='7' width='20' height='5'/%3E%3Cline x1='12' y1='22' x2='12' y2='7'/%3E%3Cpath d='M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z'/%3E%3Cpath d='M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z'/%3E%3C/svg%3E";

            const backFace = shell.querySelector('.gift-back');

            for (let i = 0; i < LAYER_COUNT; i++) {
                const z = -HALF_DEPTH + (2 * HALF_DEPTH * i / (LAYER_COUNT - 1));
                // Brightness gradient: darker at edges, brighter in middle
                const t = Math.abs(z) / HALF_DEPTH; // 0 at center, 1 at edges
                const bright = 0.45 + (1 - t) * 0.35; // 0.45 at edges, 0.8 at center

                const div = document.createElement('div');
                div.className = 'gift-depth-slice';
                div.style.transform = 'translateZ(' + z.toFixed(2) + 'px)';

                const img = document.createElement('img');
                img.src = hollowSvg;
                img.alt = '';
                img.style.filter = 'brightness(' + bright.toFixed(2) + ') contrast(1.2)';
                div.appendChild(img);

                shell.insertBefore(div, backFace);
            }
        })();
    </script>

    <script>
        const BASE_POLL_INTERVAL = 300;
        const RENDER_MODE = 'full'; // 'full' | 'safe'
        let lastGifterId = '';

        const container = document.getElementById('gifter-anchor');
        const surfaceEl = document.getElementById('wave-container');
        const nameEl = document.getElementById('gifter-name');
        const textGroupEl = document.querySelector('.gifter-text-group');
        const ashCanvas = document.getElementById('ash-canvas');
        const ashCtx = ashCanvas.getContext('2d', { alpha: true });
        const reduceMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
        let isBannerVisible = true;
        let pollIntervalMs = BASE_POLL_INTERVAL;
        let pollTimer = null;
        let pollFailures = 0;
        let lastShownName = '';

        const MIN_ANCHOR_WIDTH = 420;
        const HORIZONTAL_GUTTER = 40;
        const FIXED_CHROME_WIDTH = 25 + 18 + 60 + 20 + 8; // left padding + right padding + icon + gap + small safety
        const ashes = [];
        const ASH_COUNT = 15;
        let ashColor = { r: 255, g: 255, b: 255 };
        let ashW = 0;
        let ashH = 0;
        let ashAnimFrame = null;
        let ashLastTs = 0;

        function hasValidName(name) {
            const normalized = (name || '').trim();
            if (!normalized) return false;
            const lowered = normalized.toLowerCase();
            return normalized !== '-' &&
                normalized !== '0' &&
                lowered !== 'none' &&
                lowered !== 'null' &&
                lowered !== 'n/a' &&
                lowered !== 'na';
        }

        function setBannerVisibility(visible) {
            if (isBannerVisible === visible) return;
            isBannerVisible = visible;
            container.hidden = !visible;
        }

        function parseColorToRgb(input) {
            const m = (input || '').trim().match(/rgba?\(\s*([0-9.]+)\s*,\s*([0-9.]+)\s*,\s*([0-9.]+)/i);
            if (!m) return { r: 255, g: 255, b: 255 };
            return {
                r: Math.max(0, Math.min(255, Math.round(parseFloat(m[1])))),
                g: Math.max(0, Math.min(255, Math.round(parseFloat(m[2])))),
                b: Math.max(0, Math.min(255, Math.round(parseFloat(m[3]))))
            };
        }

        function refreshAshColor() {
            const cssColor =
                getComputedStyle(document.documentElement).getPropertyValue('--neon-green') ||
                getComputedStyle(document.documentElement).getPropertyValue('--label-glow') ||
                'rgba(255,255,255,0.45)';
            ashColor = parseColorToRgb(cssColor);
        }

        function resizeAshCanvas() {
            const dpr = Math.max(1, window.devicePixelRatio || 1);
            const rect = surfaceEl.getBoundingClientRect();
            ashW = Math.max(1, Math.floor(rect.width));
            ashH = Math.max(1, Math.floor(rect.height));
            ashCanvas.width = Math.floor(ashW * dpr);
            ashCanvas.height = Math.floor(ashH * dpr);
            ashCanvas.style.width = ashW + 'px';
            ashCanvas.style.height = ashH + 'px';
            ashCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        function resetAsh(p) {
            p.x = -40 - Math.random() * 60;
            p.y = ashH + Math.random() * 28;
            p.vx = 0.7 + Math.random() * 0.9;
            p.vy = 0.35 + Math.random() * 0.55;
            p.size = 6.4 + Math.random() * 16.0;
            p.rot = Math.random() * Math.PI * 2;
            p.vrot = (Math.random() - 0.5) * 0.07;
            p.alpha = 0.18 + Math.random() * 0.42;
            p.ttl = 420 + Math.random() * 260;
            p.age = 0;
            p.seed = Math.random() * Math.PI * 2;
        }

        function initAsh() {
            ashes.length = 0;
            for (let i = 0; i < ASH_COUNT; i++) {
                const p = {};
                resetAsh(p);
                p.x += Math.random() * ashW;
                p.y -= Math.random() * ashH;
                ashes.push(p);
            }
        }

        function drawAsh(timestamp) {
            ashCtx.clearRect(0, 0, ashW, ashH);
            if (!ashLastTs) ashLastTs = timestamp || performance.now();
            const rawDt = ((timestamp || performance.now()) - ashLastTs) / 16.6667;
            const dt = Math.max(0.5, Math.min(1.75, rawDt));
            ashLastTs = (timestamp || performance.now());
            const glowEnabled = window.GLOW_KICK_RECT !== false;
            const opacityMul = glowEnabled ? 1 : 0.35;

            for (let i = 0; i < ashes.length; i++) {
                const p = ashes[i];
                p.age += dt;
                p.x += (p.vx + Math.sin((p.age * 0.05) + p.seed) * 0.18) * dt;
                p.y -= (p.vy + Math.cos((p.age * 0.04) + p.seed) * 0.08) * dt;
                p.rot += p.vrot * dt;

                if (p.x > ashW + 28 || p.y < -24 || p.age > p.ttl) {
                    resetAsh(p);
                }

                const lifeFade = 1 - (p.age / p.ttl);
                const a = Math.max(0, p.alpha * lifeFade * opacityMul);
                if (a <= 0.01) continue;

                ashCtx.save();
                ashCtx.translate(p.x, p.y);
                ashCtx.rotate(p.rot);
                ashCtx.fillStyle = `rgba(${ashColor.r}, ${ashColor.g}, ${ashColor.b}, ${a.toFixed(3)})`;
                const w = p.size * (0.85 + Math.random() * 0.8);
                const h = p.size * (0.35 + Math.random() * 0.5);
                ashCtx.beginPath();
                ashCtx.moveTo(-w * 0.6, -h * 0.2);
                ashCtx.lineTo(w * 0.65, -h * 0.45);
                ashCtx.lineTo(w * 0.38, h * 0.55);
                ashCtx.lineTo(-w * 0.72, h * 0.35);
                ashCtx.closePath();
                ashCtx.fill();
                ashCtx.restore();
            }

            ashAnimFrame = requestAnimationFrame(drawAsh);
        }

        function clamp(val, min, max) {
            return Math.min(max, Math.max(min, val));
        }

        function setWaveVar(name, value) {
            surfaceEl.style.setProperty(name, value);
        }

        function updateAnchorWidth() {
            if (!container || !nameEl || !textGroupEl) return;

            const textWidth = Math.ceil(textGroupEl.scrollWidth);
            const desiredWidth = Math.max(MIN_ANCHOR_WIDTH, FIXED_CHROME_WIDTH + textWidth);
            const maxWidth = Math.max(MIN_ANCHOR_WIDTH, window.innerWidth - (HORIZONTAL_GUTTER * 2));
            const finalWidth = Math.min(desiredWidth, maxWidth);

            container.style.width = `${finalWidth}px`;

            const availableTextWidth = Math.max(120, finalWidth - FIXED_CHROME_WIDTH);
            if (desiredWidth > maxWidth) {
                nameEl.style.maxWidth = `${availableTextWidth}px`;
                nameEl.style.overflow = 'hidden';
                nameEl.style.textOverflow = 'ellipsis';
            } else {
                nameEl.style.maxWidth = 'none';
                nameEl.style.overflow = 'visible';
                nameEl.style.textOverflow = 'clip';
            }
        }

        function resetMotionState() {
            setWaveVar('--sheen-pos', '48%');
            setWaveVar('--rim-alpha', '0.26');
            setWaveVar('--poly-alpha', '0.24');
        }

        function showGifter(name, id) {
            if (!name) return;
            if (id && id === lastGifterId) return;
            lastGifterId = id;
            lastShownName = name;
            setBannerVisibility(true);
            nameEl.classList.remove('gifter-flash');
            void container.offsetWidth;
            nameEl.textContent = name;
            updateAnchorWidth();
            nameEl.classList.add('gifter-flash');
            if (surfaceEl) {
                surfaceEl.classList.remove('event-burst');
                void surfaceEl.offsetWidth;
                surfaceEl.classList.add('event-burst');
            }
        }

        // Tips logic removed as per user request
        window.updateTips = function (name, amount, id) {
            // No-op
        };

        window.updateFollowers = function (val, extra, id) {
            // extra format: "Latest: Username"
            const parsedCount = parseInt(val, 10);
            if (!Number.isNaN(parsedCount) && parsedCount <= 0) {
                lastShownName = '';
                nameEl.textContent = '';
                setBannerVisibility(false);
                return;
            }

            let name = extra;
            if (extra && extra.includes(':')) {
                name = extra.split(':')[1].trim();
            }
            if (hasValidName(name)) {
                showGifter(name, id);
                container.classList.remove('gold-applied');
                return;
            }

            lastShownName = '';
            nameEl.textContent = '';
            setBannerVisibility(false);
        };

        function schedulePoll(ms) {
            if (pollTimer) clearTimeout(pollTimer);
            pollTimer = setTimeout(pollAll, ms);
        }

        function injectScript(filename, id) {
            const old = document.getElementById(id);
            if (old) old.remove();
            const s = document.createElement('script');
            s.src = filename + '?t=' + Date.now();
            s.id = id;
            s.async = true;
            s.onload = () => {
                pollFailures = 0;
                pollIntervalMs = BASE_POLL_INTERVAL;
                schedulePoll(pollIntervalMs);
            };
            s.onerror = () => {
                pollFailures += 1;
                pollIntervalMs = Math.min(BASE_POLL_INTERVAL * Math.pow(2, pollFailures), 8000);
                schedulePoll(pollIntervalMs);
            };
            document.body.appendChild(s);
        }

        function pollAll() {
            injectScript('../Data/data_followers.js', 'script-followers');
            injectScript('../Settings/settings.js', 'script-settings');
        }

        function onMotionPreferenceChange() {
            if (reduceMotionQuery.matches) {
                resetMotionState();
                applyRenderMode();
            }
        }

        function applyRenderMode() {
            if (RENDER_MODE !== 'safe') return;
            setWaveVar('--poly-alpha', '0.22');
            setWaveVar('--rim-alpha', '0.26');
            const lightning = document.querySelector('.lightning-wash');
            const noise = document.querySelector('.micro-noise');
            if (lightning) lightning.style.display = 'none';
            if (noise) noise.style.display = 'none';
        }

        if (typeof reduceMotionQuery.addEventListener === 'function') {
            reduceMotionQuery.addEventListener('change', onMotionPreferenceChange);
        } else if (typeof reduceMotionQuery.addListener === 'function') {
            reduceMotionQuery.addListener(onMotionPreferenceChange);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                resetMotionState();
                applyRenderMode();
            }
        });

        window.addEventListener('resize', () => {
            if (isBannerVisible && lastShownName) updateAnchorWidth();
        });
        requestAnimationFrame(updateAnchorWidth);
        setBannerVisibility(false);

        resetMotionState();
        applyRenderMode();

        refreshAshColor();
        resizeAshCanvas();
        initAsh();
        if (!ashAnimFrame) ashAnimFrame = requestAnimationFrame(drawAsh);
        window.addEventListener('resize', resizeAshCanvas);
        if (window.ResizeObserver) {
            const ashResizeObserver = new ResizeObserver(resizeAshCanvas);
            ashResizeObserver.observe(surfaceEl);
        }

        // ==========================================
        // SATIN SHEEN JS ANIMATION
        // ==========================================
        let sheenProgress = 0;
        let sheenDirection = 1;
        const SHEEN_SPEED = 0.0025; // Slower speed (half of 0.005)

        function updateSatinSheen() {
            const nameEl = document.getElementById('gifter-name');
            if (nameEl) {
                sheenProgress += SHEEN_SPEED * sheenDirection;

                if (sheenProgress >= 1) {
                    sheenProgress = 1;
                    sheenDirection = -1;
                } else if (sheenProgress <= 0) {
                    sheenProgress = 0;
                    sheenDirection = 1;
                }

                // Map 0-1 to 0%-100%
                const posPct = (sheenProgress * 100).toFixed(1);
                nameEl.style.backgroundPosition = `${posPct}% 50%`;
            }
            requestAnimationFrame(updateSatinSheen);
        }

        // Start the JS sheen loop
        requestAnimationFrame(updateSatinSheen);

        pollAll();
    </script>

    <!-- Color Settings Loader -->
    <script src="../Settings/settings.js"></script>
    <script src="../Data/data_tips.js"></script>
    <script>
        (function () {
            // ╔══════════════════════════════════════════════════════════════════╗
            // ║              EMBEDDED SMOOTH HUE ENGINE                         ║
            // ╚══════════════════════════════════════════════════════════════════╝

            const BASE_COLORS = {
                // Keep container strictly monochrome; only text glow hue shifts.
                '--neon-green': 'rgba(10, 255, 10, 0.95)'
            };

            const State = {
                currentHue: 0,
                targetHue: 0,
                animationFrame: null
            };

            function lerp(start, end, factor) {
                return start + (end - start) * factor;
            }

            function animate() {
                const diff = State.targetHue - State.currentHue;
                if (Math.abs(diff) > 0.05) {
                    State.currentHue = lerp(State.currentHue, State.targetHue, 0.08);
                    updateColors();
                    State.animationFrame = requestAnimationFrame(animate);
                } else if (Math.abs(diff) > 0) {
                    State.currentHue = State.targetHue;
                    updateColors();
                    State.animationFrame = null;
                } else {
                    State.animationFrame = null;
                }
            }

            function updateColors() {
                if (!window.adjustHue) return;
                const style = document.documentElement.style;

                // 1. Core Theme Colors
                const themeHue = State.currentHue;
                const themeShade = window.GLOBAL_COLOR_BRIGHTNESS !== undefined ? window.GLOBAL_COLOR_BRIGHTNESS : 1.0;
                const themeSat = window.GLOBAL_COLOR_SATURATION !== undefined ? window.GLOBAL_COLOR_SATURATION : 1.0;

                for (const key in BASE_COLORS) {
                    const oldShade = window.GLOBAL_COLOR_BRIGHTNESS;
                    const oldSat = window.GLOBAL_COLOR_SATURATION;
                    window.GLOBAL_COLOR_BRIGHTNESS = themeShade;
                    window.GLOBAL_COLOR_SATURATION = themeSat;
                    style.setProperty(key, window.adjustHue(BASE_COLORS[key], themeHue));
                    window.GLOBAL_COLOR_BRIGHTNESS = oldShade;
                    window.GLOBAL_COLOR_SATURATION = oldSat;
                }
            }

            function loadSettings() {
                const old = document.getElementById('settings-script');
                if (old) old.remove();

                const s = document.createElement('script');
                s.src = '../Settings/settings.js?t=' + Date.now();
                s.onload = () => {
                    const nt = window.GLOBAL_HUE_OFFSET || 0;
                    if (nt !== State.targetHue) { State.targetHue = nt; if (!State.animationFrame) animate(); }
                    document.documentElement.style.filter = `brightness(${window.GLOBAL_BRIGHTNESS || 1.0})`;

                    const glow = window.GLOW_KICK_RECT !== false; // Reuse rect glow for consistency in top area
                    const name = document.querySelector('.gifter-name');

                    if (glow) {
                        if (name) name.classList.add('text-glow');
                    } else {
                        if (name) name.classList.remove('text-glow');
                    }

                    updateColors();
                    refreshAshColor();
                };
                document.head.appendChild(s);
            }

            function applyFilters() {
                const bright = window.GLOBAL_BRIGHTNESS !== undefined ? window.GLOBAL_BRIGHTNESS : 1.0;
                document.documentElement.style.filter = `brightness(${bright})`;
            }

            loadSettings();
            setInterval(loadSettings, 300);
        })();
    </script>
</body>

</html>